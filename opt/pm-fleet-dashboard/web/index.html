<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Pi Fleet Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#0b0f14;
  --card:#161b22;
  --border:#30363d;
  --text:#e6edf3;
  --muted:#8b949e;
  --good:#2ea043;
  --warn:#d29922;
  --bad:#f85149;
  --accent:#58a6ff;
}

body {
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  margin:20px;
}

h1 { color:var(--accent); margin-bottom:6px; }

.summary {
  margin-bottom:18px;
  color:var(--muted);
  font-size:14px;
}

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:16px;
}

.card {
  background:var(--card);
  padding:16px;
  border-radius:12px;
  box-shadow:0 0 0 1px var(--border);
  transition:.15s ease;
}

.card:hover { transform:translateY(-2px); }

.good { border-left:4px solid var(--good); }
.warn { border-left:4px solid var(--warn); }
.bad  { border-left:4px solid var(--bad); }
.offline { border-left:4px solid #6e7681; opacity:.65; }

.small { color:var(--muted); font-size:12px; }

.badge {
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  margin-left:6px;
}

.badge.good { background:rgba(46,160,67,.15); color:var(--good); }
.badge.warn { background:rgba(210,153,34,.18); color:var(--warn); }
.badge.bad  { background:rgba(248,81,73,.18); color:var(--bad); }
.badge.offline { background:rgba(110,118,129,.25); color:#c9d1d9; }

.status {
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

.refresh {
  float:right;
  font-size:12px;
  color:var(--muted);
}

.bar {
  height:6px;
  background:#222;
  border-radius:999px;
  overflow:hidden;
  margin-top:10px;
}

.bar-inner {
  height:100%;
  background:var(--accent);
  width:0%;
  transition:width .4s ease;
}

.cmds {
  margin-top:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

button {
  background:#21262d;
  color:#e6edf3;
  border:1px solid #30363d;
  border-radius:6px;
  padding:4px 10px;
  font-size:12px;
  cursor:pointer;
}

button:hover { background:#30363d; }

button:disabled {
  opacity:.4;
  cursor:not-allowed;
}

button.busy {
  background:#58a6ff;
  color:#000;
}
</style>
</head>
<body>

<h1>
üõ∞Ô∏è Pi Fleet
<span id="refresh" class="refresh">refreshing‚Ä¶</span>
</h1>

<div id="summary" class="summary">Loading fleet‚Ä¶</div>
<div class="bar"><div id="healthBar" class="bar-inner"></div></div>
<div id="grid" class="grid"></div>

<script>
let lastFetchTime = 0;

// --------------------------------------------------
// helpers
// --------------------------------------------------

function healthClass(score) {
  if (score === 0) return 'offline';
  if (score < 50) return 'bad';
  if (score < 75) return 'warn';
  return 'good';
}

function healthLabel(score) {
  if (score === 0) return ['offline','OFFLINE'];
  if (score < 50) return ['bad','CRITICAL'];
  if (score < 75) return ['warn','WARN'];
  return ['good','OK'];
}

function formatUptime(sec) {
  if (!sec) return '-';
  sec = Math.floor(sec);
  const d = Math.floor(sec/86400);
  const h = Math.floor((sec%86400)/3600);
  const m = Math.floor((sec%3600)/60);
  if (d > 0) return `${d}d ${h}h`;
  return `${h}h ${m}m`;
}

function secondsAgo(ts) {
  if (!ts) return '-';
  const s = Math.floor((Date.now()/1000) - ts);
  if (s < 60) return `${s}s ago`;
  if (s < 3600) return `${Math.floor(s/60)}m ago`;
  return `${Math.floor(s/3600)}h ago`;
}

// --------------------------------------------------
// command sender (timestamp ready)
// --------------------------------------------------

async function sendCmd(btn, ip, cmd) {
  if (!ip) return;

  btn.classList.add('busy');
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = '‚Ä¶';

  try {
    const payload = {
      ip,
      cmd,
      ts: Math.floor(Date.now()/1000)
    };

    const res = await fetch('/api/cmd', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    btn.textContent = res.ok ? '‚úì' : 'ERR';

  } catch {
    btn.textContent = 'ERR';
  }

  setTimeout(()=>{
    btn.textContent = old;
    btn.classList.remove('busy');
    btn.disabled = false;
  },1500);
}

// --------------------------------------------------
// main loader
// --------------------------------------------------

async function loadFleet() {
  document.getElementById('refresh').textContent = 'refreshing‚Ä¶';

  try {
    const res = await fetch('/api/fleet', {cache:'no-store'});
    if (!res.ok) throw new Error('bad response');

    const data = await res.json();
    lastFetchTime = Date.now()/1000;

    renderFleet(data);

    document.getElementById('refresh').textContent =
      'updated ' + new Date().toLocaleTimeString();

  } catch (err) {
    console.error(err);
    document.getElementById('summary').textContent =
      '‚ö†Ô∏è Fleet unreachable ‚Äî retrying‚Ä¶';
    document.getElementById('refresh').textContent = 'error';
  }
}

// --------------------------------------------------
// renderer
// --------------------------------------------------

function renderFleet(data) {
  const grid = document.getElementById('grid');

  data.sort((a,b)=>{
    const sa = a.boot_health?.score ?? 0;
    const sb = b.boot_health?.score ?? 0;
    return sa - sb;
  });

  grid.innerHTML = '';

  let good=0, warn=0, bad=0, off=0;
  let scoreTotal = 0;

  data.forEach(d => {
    const score = d.boot_health?.score ?? 0;
    const cls = healthClass(score);
    const [badgeCls,label] = healthLabel(score);
    const offline = score === 0;

    if (cls==='good') good++;
    else if (cls==='warn') warn++;
    else if (cls==='bad') bad++;
    else off++;

    scoreTotal += score;

    const el = document.createElement('div');
    el.className = 'card ' + cls;

    el.innerHTML = `
      <h3>
        ${d.device?.device_id || 'unknown'}
        <span class="badge ${badgeCls}">${label}</span>
      </h3>

      <div>Role: ${d.device?.role || '-'}</div>
      <div>Site: ${d.device?.site || '-'}</div>
      <div>Health: <b>${score}</b></div>

      <div class="status small">
        Host: ${d.hostname || '-'}<br>
        Uptime: ${formatUptime(d.uptime_sec)}<br>
        Seen: ${secondsAgo(d.timestamp)}
      </div>

      <div class="cmds">
        <button ${offline?'disabled':''}
          onclick="sendCmd(this,'${d.ip}','reboot')">Reboot</button>
        <button ${offline?'disabled':''}
          onclick="sendCmd(this,'${d.ip}','shutdown')">Shutdown</button>
        <button ${offline?'disabled':''}
          onclick="sendCmd(this,'${d.ip}','update')">Update</button>
        <button ${offline?'disabled':''}
          onclick="sendCmd(this,'${d.ip}','rotate-key')">Rotate Key</button>
      </div>
    `;

    grid.appendChild(el);
  });

  document.getElementById('summary').textContent =
    `Nodes: ${data.length}  ‚Ä¢  OK:${good}  WARN:${warn}  BAD:${bad}  OFFLINE:${off}`;

  const avg = data.length ? (scoreTotal / data.length) : 0;
  document.getElementById('healthBar').style.width = avg + '%';
}

// --------------------------------------------------

loadFleet();
setInterval(loadFleet, 5000);
</script>

</body>
</html>