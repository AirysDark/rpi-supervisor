#!/usr/bin/env bash
set -euo pipefail

KEY="/etc/pm-device-key"
NEXT="/etc/pm-device-key.next"
EPOCH="/var/lib/pm-key-epoch"

echo "[pm-key] bootstrap starting"

mkdir -p /var/lib

# --------------------------------------------------
# ACTIVE KEY
# --------------------------------------------------

if [[ ! -f "$KEY" ]]; then
  echo "[pm-key] generating device key"
  openssl rand -hex 32 > "$KEY"
  chmod 600 "$KEY"
else
  echo "[pm-key] device key exists"
fi

# --------------------------------------------------
# CLEAN STALE NEXT KEY
# --------------------------------------------------

if [[ -f "$NEXT" ]]; then
  echo "[pm-key] removing stale next key"
  rm -f "$NEXT"
fi

# --------------------------------------------------
# EPOCH INIT
# --------------------------------------------------

if [[ ! -f "$EPOCH" ]]; then
  echo "[pm-key] initializing epoch"
  echo "1" > "$EPOCH"
else
  echo "[pm-key] epoch exists ($(cat "$EPOCH"))"
fi

echo "[pm-key] bootstrap complete"