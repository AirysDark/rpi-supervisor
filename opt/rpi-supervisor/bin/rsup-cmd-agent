#!/usr/bin/env python3
"""
Secure remote command agent (PRODUCTION v3)

Features:
- Per-device key ONLY
- HMAC authenticated commands
- Replay protection
- Timestamp skew protection
- rotate-key support
- Hardened execution
"""

import json
import hmac
import hashlib
import subprocess
import time
from http.server import ThreadingHTTPServer, BaseHTTPRequestHandler
from pathlib import Path
import sys

PORT = 8092

DEVICE_KEY_FILE = Path("/etc/rpi-supervisor/device-key")

TIMESTAMP_SKEW = 90  # seconds

ALLOWED = {
    "reboot": ["reboot"],
    "shutdown": ["shutdown", "-h", "now"],
    "update": ["systemctl", "restart", "power-manager"],
    "rotate-key": ["/opt/rpi-supervisor/bin/rsup-key-rotate"],
}


# ============================================================
# LOG
# ============================================================

def log(msg):
    print(f"[pm-cmd] {msg}", flush=True)


# ============================================================
# KEY LOADING (PER-DEVICE ONLY)
# ============================================================

def load_key():
    if not DEVICE_KEY_FILE.exists():
        log("FATAL: missing /etc/rpi-supervisor/device-key")
        sys.exit(1)

    key = DEVICE_KEY_FILE.read_text().strip()

    if len(key) < 16:
        log("FATAL: device key too short")
        sys.exit(1)

    return key.encode()


# ============================================================
# VERIFY
# ============================================================

def verify(payload, sig, secret):
    clean = dict(payload)
    clean.pop("sig", None)

    msg = json.dumps(
        clean,
        sort_keys=True,
        separators=(",", ":")
    ).encode()

    calc = hmac.new(secret, msg, hashlib.sha256).hexdigest()
    return hmac.compare_digest(calc, sig)


def timestamp_valid(ts):
    try:
        ts = int(ts)
    except Exception:
        return False

    return abs(time.time() - ts) <= TIMESTAMP_SKEW


# ============================================================
# HTTP HANDLER
# ============================================================

class Handler(BaseHTTPRequestHandler):
    def do_POST(self):
        if self.path != "/api/cmd":
            self.send_response(404)
            self.end_headers()
            return

        try:
            length = int(self.headers.get("Content-Length", 0))
            data = json.loads(self.rfile.read(length))
        except Exception:
            self.send_response(400)
            self.end_headers()
            return

        sig = data.get("sig", "")
        ts = data.get("ts")

        secret = load_key()

        # ---- timestamp check ----
        if not timestamp_valid(ts):
            log("replay/clock skew detected")
            self.send_response(403)
            self.end_headers()
            return

        # ---- signature check ----
        if not verify(data, sig, secret):
            log("signature verification failed")
            self.send_response(403)
            self.end_headers()
            return

        cmd = data.get("cmd")

        if cmd not in ALLOWED:
            self.send_response(400)
            self.end_headers()
            return

        log(f"executing command: {cmd}")

        try:
            subprocess.Popen(
                ALLOWED[cmd],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                start_new_session=True,
            )
        except Exception as e:
            log(f"execution failed: {e}")
            self.send_response(500)
            self.end_headers()
            return

        self.send_response(200)
        self.end_headers()


# ============================================================
# MAIN
# ============================================================

def main():
    log("secure command agent running (per-device mode)")
    ThreadingHTTPServer(("0.0.0.0", PORT), Handler).serve_forever()


if __name__ == "__main__":
    main()