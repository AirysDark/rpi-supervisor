#!/usr/bin/env python3
"""
Rpi Supervisor — Crash-only log capture (Self-healing)

If previous boot was unclean, dump journal to /boot.
Also ensures clean-shutdown marker helper exists.

Safe for RO-root systems.
"""

import subprocess
from pathlib import Path
import os

# ============================================================
# PATHS (Rpi Supervisor standard)
# ============================================================

RUNTIME_DIR = Path("/run/rpi-supervisor")
MARKER = RUNTIME_DIR / "clean-shutdown.flag"

LOG_DUMP = Path("/usr/local/bin/rsup-logdump")
MARK_SCRIPT = Path("/usr/local/bin/rsup-mark-clean-shutdown")

MARK_SCRIPT_CONTENT = """#!/usr/bin/env bash
set -euo pipefail
mkdir -p /run/rpi-supervisor
touch /run/rpi-supervisor/clean-shutdown.flag
"""

# ============================================================
# HELPERS
# ============================================================

def log(msg: str):
    print(f"[rsup-crash] {msg}", flush=True)


def run_quiet(cmd):
    try:
        subprocess.run(
            cmd,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            check=False,
        )
    except Exception as e:
        log(f"Command failed: {cmd} ({e})")


def ensure_runtime_dir():
    try:
        RUNTIME_DIR.mkdir(parents=True, exist_ok=True)
    except Exception as e:
        log(f"Failed to create runtime dir: {e}")


# ============================================================
# SELF-HEAL: ensure marker helper exists
# ============================================================

def ensure_marker_helper():
    if MARK_SCRIPT.exists():
        return

    log("Installing rsup-mark-clean-shutdown helper")

    try:
        MARK_SCRIPT.write_text(MARK_SCRIPT_CONTENT)
        os.chmod(MARK_SCRIPT, 0o755)
    except Exception as e:
        log(f"Failed to install marker helper: {e}")


# ============================================================
# LOGIC
# ============================================================

def was_clean_shutdown() -> bool:
    return MARKER.exists()


def clear_marker():
    try:
        MARKER.unlink(missing_ok=True)
    except Exception:
        pass


def dump_logs():
    if not LOG_DUMP.exists():
        log("rsup-logdump missing — cannot capture logs")
        return

    log("UNCLEAN SHUTDOWN DETECTED — dumping logs")
    run_quiet([str(LOG_DUMP)])


# ============================================================
# MAIN
# ============================================================

def main():
    ensure_runtime_dir()
    ensure_marker_helper()

    if was_clean_shutdown():
        log("Previous shutdown clean")
        clear_marker()
        return

    dump_logs()
    clear_marker()


if __name__ == "__main__":
    main()