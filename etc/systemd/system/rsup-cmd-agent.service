[Unit]
Description=Rpi Supervisor Remote Command Agent
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/opt/rpi-supervisor/bin/rsup-cmd-agent
Restart=always
RestartSec=2

# --- run as root (needed for reboot/shutdown) ---
User=root
Group=root

# --- security hardening ---
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ProtectControlGroups=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectKernelLogs=yes
ProtectClock=yes
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictRealtime=yes
RestrictSUIDSGID=yes

# allow required write paths
ReadWritePaths=/run /var/lib/rpi-supervisor

# networking allowed
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX

# capabilities required for reboot/shutdown
CapabilityBoundingSet=CAP_SYS_BOOT CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_SYS_BOOT

# nice behavior
KillMode=process
TimeoutStopSec=10

[Install]
WantedBy=multi-user.target